{% extends "base.html" %}

{% block content %}
<div class="crawler-page">
    <div class="page-header">
        <h1>爬虫任务管理</h1>
        <a href="{{ url_for('crawler.create_task') }}" class="btn btn-primary">+ 创建任务</a>
    </div>
    
    <div class="crawler-stats">
        <div class="stat-card">
            <div class="stat-value">{{ tasks|length }}</div>
            <div class="stat-label">任务总数</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ running_count }}</div>
            <div class="stat-label">运行中</div>
        </div>
        <a href="{{ url_for('crawler.crawl_history') }}" class="btn btn-secondary">执行历史</a>
    </div>
    
    {% if tasks %}
    <div class="task-list">
        {% for task in tasks %}
        <div class="task-card">
            <div class="task-header">
                <h3>{{ task.name }}</h3>
                <span class="status-badge status-{{ task.status }}">{{ task.status }}</span>
            </div>
            
            <div class="task-info">
                <p><strong>目标网站:</strong> {{ task.website }}</p>
                {% if task.keywords %}
                <p><strong>关键词:</strong> {{ task.keywords }}</p>
                {% endif %}
                {% if task.category %}
                <p><strong>分类:</strong> {{ task.category }}</p>
                {% endif %}
            </div>
            
            <div class="task-stats">
                <span>已采集: {{ task.total_crawled }} 条</span>
                <span>成功率: {{ "%.1f"|format((task.success_count / task.total_crawled * 100) if task.total_crawled > 0 else 0) }}%</span>
                {% if task.last_crawl_time %}
                <span>最后执行: {{ task.last_crawl_time.strftime('%Y-%m-%d %H:%M') }}</span>
                {% endif %}
            </div>
            
            <div class="task-actions">
                <a href="{{ url_for('crawler.task_detail', task_id=task.id) }}" class="btn btn-sm">详情</a>
                
                {% if task.status == 'running' %}
                <form action="{{ url_for('crawler.stop_task', task_id=task.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-sm btn-warning">停止</button>
                </form>
                {% else %}
                <form action="{{ url_for('crawler.start_task', task_id=task.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-sm btn-success">启动</button>
                </form>
                {% endif %}
                
                <form action="{{ url_for('crawler.run_now', task_id=task.id) }}" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-sm btn-secondary">立即执行</button>
                </form>
                
                <form action="{{ url_for('crawler.delete_task', task_id=task.id) }}" method="POST" class="inline-form" onsubmit="return confirm('确定要删除此任务吗？');">
                    <button type="submit" class="btn btn-sm btn-danger">删除</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>暂无爬虫任务</p>
        <a href="{{ url_for('crawler.create_task') }}" class="btn btn-primary">创建任务</a>
    </div>
    {% endif %}
</div>
{% endblock %}
