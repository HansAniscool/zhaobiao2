{% extends "base.html" %}

{% block content %}
<div class="crawler-page">
    <div class="page-header">
        <h1>爬虫执行历史</h1>
        <a href="{{ url_for('crawler.crawler_index') }}" class="btn btn-secondary">返回任务列表</a>
    </div>
    
    {% if histories %}
    <div class="history-table">
        <table>
            <thead>
                <tr>
                    <th>任务</th>
                    <th>开始时间</th>
                    <th>结束时间</th>
                    <th>状态</th>
                    <th>发现</th>
                    <th>新增</th>
                    <th>跳过</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for history in histories %}
                <tr>
                    <td>{{ history.task.name }}</td>
                    <td>{{ history.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ history.end_time.strftime('%Y-%m-%d %H:%M:%S') if history.end_time else '-' }}</td>
                    <td>
                        <span class="status-badge status-{{ history.status }}">
                            {{ '成功' if history.status == 'completed' else ('失败' if history.status == 'failed' else '运行中') }}
                        </span>
                    </td>
                    <td>{{ history.items_found }}</td>
                    <td>{{ history.items_added }}</td>
                    <td>{{ history.items_skipped }}</td>
                    <td>
                        {% if history.error_message %}
                        <button class="btn-link" onclick="showError('{{ history.error_message }}')">查看错误</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% for page in range(1, pagination.pages + 1) %}
        {% if page == pagination.page %}
        <span class="page-link active">{{ page }}</span>
        {% else %}
        <a href="{{ url_for('crawler.crawl_history', page=page) }}" class="page-link">{{ page }}</a>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <p>暂无执行记录</p>
    </div>
    {% endif %}
</div>

<div id="errorModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>错误信息</h3>
        <pre id="errorContent"></pre>
    </div>
</div>

<script>
function showError(msg) {
    document.getElementById('errorContent').textContent = msg;
    document.getElementById('errorModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('errorModal').style.display = 'none';
}

window.onclick = function(event) {
    if (event.target == document.getElementById('errorModal')) {
        closeModal();
    }
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
}

.close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

#errorContent {
    background: #f5f5f5;
    padding: 10px;
    border-radius: 4px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
{% endblock %}
