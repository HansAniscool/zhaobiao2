{% extends "base.html" %}

{% block title %}åå°ä»»åŠ¡ç›‘æ§ - æ‹›æ ‡ä¿¡æ¯ç½‘{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/monitor.css') }}">
{% endblock %}

{% block content %}
<div class="monitor-page">
    <div class="monitor-header">
        <div class="monitor-title">
            <h1>ğŸ”„ åå°çˆ¬è™«ä»»åŠ¡ç›‘æ§</h1>
            <p class="monitor-subtitle">å®æ—¶ç›‘æ§æ‰€æœ‰çˆ¬è™«ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€</p>
        </div>
        <div class="monitor-controls">
            <div class="refresh-info">
                <span class="refresh-status" id="refresh-status">â— å®æ—¶åˆ·æ–°ä¸­</span>
                <span class="last-update" id="last-update">æœ€åæ›´æ–°: --:--:--</span>
            </div>
            <button onclick="fetchAllTasks()" class="btn btn-refresh">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
            <a href="{{ url_for('tenders.search') }}" class="btn btn-primary">è¿”å›æœç´¢</a>
        </div>
    </div>

    <div class="monitor-stats" id="monitor-stats">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-info">
                <div class="stat-value" id="total-tasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ”„</div>
            <div class="stat-info">
                <div class="stat-value" id="running-tasks">0</div>
                <div class="stat-label">æ­£åœ¨è¿è¡Œ</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-info">
                <div class="stat-value" id="completed-tasks">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âŒ</div>
            <div class="stat-info">
                <div class="stat-value" id="failed-tasks">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
        </div>
    </div>

    <div class="tasks-container">
        <div class="tasks-header">
            <h2>ä»»åŠ¡åˆ—è¡¨</h2>
            <div class="filter-controls">
                <select id="status-filter" class="filter-select" onchange="filterTasks()">
                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="running">è¿è¡Œä¸­</option>
                    <option value="pending">ç­‰å¾…ä¸­</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="failed">å¤±è´¥</option>
                </select>
            </div>
        </div>
        
        <div id="tasks-list" class="tasks-list">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-text">æš‚æ— çˆ¬è™«ä»»åŠ¡</div>
                <div class="empty-hint">è¯·å‰å¾€ <a href="{{ url_for('tenders.search') }}">æœç´¢é¡µé¢</a> å¯åŠ¨æ–°çš„æœç´¢ä»»åŠ¡</div>
            </div>
        </div>
    </div>
</div>
</div>

<div id="preview-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“‹ çˆ¬å–ç»“æœé¢„è§ˆ</h3>
            <button onclick="closePreviewModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="preview-content">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½é¢„è§ˆæ•°æ®...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closePreviewModal()" class="btn btn-secondary">å…³é—­</button>
            <button id="modal-download-btn" onclick="downloadFromModal()" class="btn btn-download" style="display: none;">
                <span class="btn-icon">ğŸ“¥</span>
                <span class="btn-text">ä¸‹è½½Excel</span>
            </button>
        </div>
    </div>
</div>

<script>
let currentTaskId = null;
let pollingInterval = null;
const POLLING_INTERVAL = 2000;

function init() {
    fetchAllTasks();
    startPolling();
}

function startPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    pollingInterval = setInterval(fetchAllTasks, POLLING_INTERVAL);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function fetchAllTasks() {
    fetch('/crawl/tasks')
        .then(response => response.json())
        .then(data => {
            updateLastRefreshTime();
            allTasksData = data.tasks || [];
            updateTasksUI();
            updateStats();
        })
        .catch(error => {
            console.error('è·å–ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
            document.getElementById('refresh-status').textContent = 'â— åˆ·æ–°å¤±è´¥';
            document.getElementById('refresh-status').style.color = '#ef4444';
        });
}

function updateLastRefreshTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
    document.getElementById('last-update').textContent = 'æœ€åæ›´æ–°: ' + timeStr;
    document.getElementById('refresh-status').textContent = 'â— å®æ—¶åˆ·æ–°ä¸­';
    document.getElementById('refresh-status').style.color = '#22c55e';
}

function updateStats() {
    const tasks = allTasksData;
    const total = tasks.length;
    const running = tasks.filter(t => t.status === 'running').length;
    const completed = tasks.filter(t => t.status === 'completed').length;
    const failed = tasks.filter(t => t.status === 'failed').length;

    document.getElementById('total-tasks').textContent = total;
    document.getElementById('running-tasks').textContent = running;
    document.getElementById('completed-tasks').textContent = completed;
    document.getElementById('failed-tasks').textContent = failed;
}

function filterTasks() {
    updateTasksUI();
}

function updateTasksUI() {
    const container = document.getElementById('tasks-list');
    const statusFilter = document.getElementById('status-filter').value;
    
    let tasks = allTasksData;
    
    if (statusFilter !== 'all') {
        tasks = tasks.filter(t => t.status === statusFilter);
    }
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-text">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡</div>
                <div class="empty-hint">${statusFilter === 'all' ? 'è¯·å‰å¾€ <a href="/search">æœç´¢é¡µé¢</a> å¯åŠ¨æ–°çš„æœç´¢ä»»åŠ¡' : 'å°è¯•é€‰æ‹©å…¶ä»–çŠ¶æ€ç­›é€‰'}</div>
            </div>
        `;
        return;
    }

    let html = '';
    tasks.sort((a, b) => {
        const statusOrder = { 'running': 0, 'pending': 1, 'completed': 2, 'failed': 3 };
        return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
    });

    tasks.forEach(task => {
        const statusClass = task.status || 'pending';
        const statusText = {
            'pending': 'ç­‰å¾…ä¸­',
            'running': 'çˆ¬å–ä¸­',
            'completed': 'å·²å®Œæˆ',
            'failed': 'å¤±è´¥'
        }[statusClass] || statusClass;

        const percentage = task.progress_percentage || 0;
        const isRunning = statusClass === 'running';

        html += `
            <div class="task-card ${statusClass}">
                <div class="task-card-header">
                    <div class="task-id-info">
                        <span class="task-id">${task.task_id}</span>
                        <span class="task-status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="task-time-info">
                        ${task.elapsed_time ? `<span class="elapsed-time">â±ï¸ ${task.elapsed_time}</span>` : ''}
                    </div>
                </div>
                
                ${task.message ? `<div class="task-message">${task.message}</div>` : ''}
                
                <div class="task-progress-section">
                    <div class="progress-header-row">
                        <span class="progress-label">æ€»ä½“è¿›åº¦</span>
                        <span class="progress-percentage">${percentage}%</span>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-fill-large ${isRunning ? 'animate' : ''}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-stats-row">
                        <span class="progress-count">${task.completed || 0} / ${task.total || 0} ä¸ªç½‘ç«™</span>
                        ${task.status === 'completed' ? `<span class="estimated-remaining completed-text">å·²å®Œæˆ</span>` : (task.estimated_remaining ? `<span class="estimated-remaining">é¢„è®¡å‰©ä½™: ${task.estimated_remaining}</span>` : '')}
                    </div>
                    <div class="task-actions">
                        <button onclick="previewTask('${task.task_id}')" class="btn btn-preview ${task.status !== 'completed' ? 'btn-disabled' : ''}" ${task.status !== 'completed' ? 'disabled' : ''}>
                            <span class="btn-icon">ğŸ‘ï¸</span>
                            <span class="btn-text">é¢„è§ˆ</span>
                        </button>
                        <button onclick="downloadTask('${task.task_id}')" class="btn btn-download" ${task.results_count === 0 ? 'disabled' : ''}>
                            <span class="btn-icon">ğŸ“¥</span>
                            <span class="btn-text">ä¸‹è½½</span>
                        </button>
                    </div>
                </div>
                
                ${task.current_website ? `
                    <div class="current-website-section">
                        <div class="current-website-header">
                            <span class="globe-icon">ğŸŒ</span>
                            <span class="current-website-name">${task.current_website.name || 'æœªçŸ¥ç½‘ç«™'}</span>
                        </div>
                        <div class="current-website-details">
                            <span class="website-progress">è¿›åº¦: ${task.current_website.progress || 0}/${task.current_website.total || 0}</span>
                            ${task.current_website.url ? `<span class="website-url-text">${task.current_website.url}</span>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${task.websites && task.websites.length > 0 ? `
                    <div class="websites-summary">
                        <div class="websites-toggle" onclick="toggleWebsites('${task.task_id}')">
                            <span>ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…</span>
                            <span class="toggle-arrow">â–¼</span>
                        </div>
                        <div id="websites-${task.task_id}" class="websites-detail" style="display: none;">
                            <table class="websites-table">
                                <thead>
                                    <tr>
                                        <th>çŠ¶æ€</th>
                                        <th>ç½‘ç«™åç§°</th>
                                        <th>ç»“æœæ•°</th>
                                        <th>è€—æ—¶</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${task.websites.map(ws => `
                                        <tr class="${ws.status}">
                                            <td>${getStatusIcon(ws.status)}</td>
                                            <td class="website-name-cell">${ws.name || 'æœªçŸ¥'}</td>
                                            <td>${ws.found || 0} æ¡</td>
                                            <td>${ws.duration ? ws.duration + 'ç§’' : '--'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                <div class="task-footer">
                    ${task.start_time ? `<span class="start-time">å¼€å§‹: ${formatTime(task.start_time)}</span>` : ''}
                    ${task.estimated_completion ? `<span class="completion-time">é¢„è®¡å®Œæˆ: ${task.estimated_completion}</span>` : ''}
                    ${task.results_count !== undefined ? `<span class="results-count">ğŸ“Š ç»“æœ: ${task.results_count} æ¡</span>` : ''}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getStatusIcon(status) {
    const icons = {
        'pending': 'â³',
        'running': 'ğŸ”„',
        'completed': 'âœ…',
        'failed': 'âŒ'
    };
    return icons[status] || 'â“';
}

function formatTime(isoTime) {
    try {
        const date = new Date(isoTime);
        return date.toLocaleTimeString('zh-CN', { hour12: false });
    } catch {
        return isoTime;
    }
}

function toggleWebsites(taskId) {
    const detail = document.getElementById('websites-' + taskId);
    const toggle = detail.previousElementSibling.querySelector('.toggle-arrow');
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        detail.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

document.addEventListener('DOMContentLoaded', init);

function previewTask(taskId) {
    currentTaskId = taskId;
    const modal = document.getElementById('preview-modal');
    const content = document.getElementById('preview-content');
    const downloadBtn = document.getElementById('modal-download-btn');
    
    modal.style.display = 'block';
    content.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½é¢„è§ˆæ•°æ®...</p>
        </div>
    `;
    downloadBtn.style.display = 'none';
    
    fetch(`/crawl/preview/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_results) {
                content.innerHTML = data.html;
                downloadBtn.style.display = 'inline-flex';
            } else {
                content.innerHTML = `
                    <div class="preview-empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>æš‚æ— çˆ¬å–ç»“æœ</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('é¢„è§ˆåŠ è½½å¤±è´¥:', error);
            content.innerHTML = `
                <div class="preview-error">
                    <div class="error-icon">âŒ</div>
                    <p>ç½‘ç»œé”™è¯¯ï¼ŒåŠ è½½å¤±è´¥</p>
                </div>
            `;
        });
}

function downloadTask(taskId) {
    const link = document.createElement('a');
    link.href = `/crawl/download/${taskId}`;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadFromModal() {
    if (currentTaskId) {
        downloadTask(currentTaskId);
    }
}

function closePreviewModal() {
    document.getElementById('preview-modal').style.display = 'none';
    currentTaskId = null;
}

window.onclick = function(event) {
    const modal = document.getElementById('preview-modal');
    if (event.target === modal) {
        closePreviewModal();
    }
}
</script>
{% endblock %}
